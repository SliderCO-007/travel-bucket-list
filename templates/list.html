{% extends "layout.html" %} {% block title %} List {% endblock %} {% block main
%}
<div class="container mt-4">
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold">My Travel Bucket List</h1>
    <p class="lead text-muted">
      A collection of destinations you want to visit.
    </p>
  </div>

  {% if bucket_lists %}
  <div id="lists-container" class="row g-4">
    <!-- Cards will be dynamically inserted here by JavaScript -->
  </div>
  {% else %}
  <div class="alert alert-info text-center" role="alert">
    <h1>There are no destinations in your Travel Bucket List</h1>
    <p class="mt-3">
      Click <a href="/search" class="alert-link">here</a> to add a destination.
    </p>
  </div>
  {% endif %}

  <div class="mt-5 text-center">
    <h3><a href="/map">Map</a> your Travel Bucket List.</h3>
    <h3><a href="/search">Add</a> another destination.</h3>
  </div>
</div>

<script>
    const bucketLists = {{ bucket_lists | tojson }};
    const container = document.getElementById('lists-container');

    bucketLists.forEach(item => {
        const wikipediaLink = `https://en.wikipedia.org/wiki/${item.name.replace(/ /g, '_')}`;

        // Use the has_journal property to conditionally set button text and class
        const journalButtonText = item.has_journal ? 'View Journal' : 'Mark Done';
        const journalButtonClass = item.has_journal ? 'btn-outline-info' : 'btn-outline-success';
        const journalButtonTarget = item.has_journal ? '#journalHistoryModal' : '#journalModal';

        const cardColumn = document.createElement('div');
        cardColumn.className = 'col-12 col-md-4';

        cardColumn.innerHTML = `
            <div class="card h-100 shadow-sm">
                <img src="${item.url}" class="card-img-top" alt="${item.name}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-bold">${item.name}</h5>
                    <p class="card-text text-muted mb-4">${item.description}</p>
                    <p class="d-none">Coordinates: ${item.latitude}, ${item.longitude}</p>
                </div>
                <div class="card-footer d-flex justify-content-between">
                  <a href="${wikipediaLink}" target="_blank" class="btn btn-sm btn-outline-primary">Details</a>
                  <button type="button" class="btn btn-sm ${journalButtonClass}" data-bs-toggle="modal" data-bs-target="${journalButtonTarget}" data-item-id="${item.id}" data-item-name="${item.name}">
                          ${journalButtonText}
                  </button>
                  <form action="/delete-item" method="post" class="d-inline">
                          <input type="hidden" name="item_id" value="${item.id}">
                          <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                </div>
            </div>
        `;
        container.appendChild(cardColumn);
    });

    // Handle "Mark Done" modal
    const journalModal = document.getElementById('journalModal');
    if (journalModal) {
    journalModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const itemId = button.getAttribute('data-item-id');
      const itemName = button.getAttribute('data-item-name');

      const modalItemId = journalModal.querySelector('#modalItemId');
      const modalItemName = journalModal.querySelector('#modalItemName');

      modalItemId.value = itemId;
      modalItemName.textContent = itemName;
    });
  }

    // Handle "View Journal" modal
    const journalHistoryModal = document.getElementById('journalHistoryModal');
    journalHistoryModal.addEventListener('show.bs.modal', async function (event) {
        const button = event.relatedTarget;
        const itemId = button.getAttribute('data-item-id');
        const itemName = button.getAttribute('data-item-name');

        const modalBody = journalHistoryModal.querySelector('.modal-body');
        const modalTitle = journalHistoryModal.querySelector('#journalHistoryModalLabel');
        const addEntryForm = journalHistoryModal.querySelector('#addEntryForm');

        modalTitle.textContent = `Journal Entries for: ${itemName}`;
        addEntryForm.querySelector('#historyModalItemId').value = itemId;

        modalBody.innerHTML = '<p class="text-center">Loading journal entries...</p>';

        try {
            const response = await fetch(`/api/journal/${itemId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const entries = await response.json();

            if (entries.length > 0) {
                modalBody.innerHTML = entries.map(entry => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Visited on: ${entry.visited_date}</h6>
                            <p class="card-text">${entry.journal_text}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                modalBody.innerHTML = '<p class="text-center text-muted">No journal entries found. Add one below!</p>';
            }
        } catch (error) {
            console.error('Failed to fetch journal entries:', error);
            modalBody.innerHTML = `<div class="alert alert-danger">Failed to load journal entries.</div>`;
        }
    });
</script>
{% endblock %}
